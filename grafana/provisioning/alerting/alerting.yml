apiVersion: 1

groups:
  - orgId: 1
    name: Ridely Alerts
    folder: 'Ridely Alerts'
    interval: 30s
    rules:
      # ---------- CPU ----------
      - uid: cpu_high
        title: High CPU Usage
        condition: C
        data:
          - refId: A
            datasourceUid: ${PROMETHEUS_UID}
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: process_cpu_user_seconds_total
              legendFormat: CPU
              interval: ''
          - refId: B
            datasourceUid: ${PROMETHEUS_UID}
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: avg_over_time(process_cpu_user_seconds_total[5m])
              legendFormat: avgCPU
              interval: ''
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expression: '${B} > 0.8'
              hide: false
              type: math
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: 'âš ï¸ CPU usage is above 80% for 2 minutes'
        labels:
          severity: warning

      # ---------- Memory ----------
      - uid: memory_high
        title: High Memory Usage
        condition: B
        data:
          - refId: A
            datasourceUid: ${PROMETHEUS_UID}
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: nodejs_heap_used_bytes / nodejs_heap_space_size_limit_bytes
              legendFormat: heap
              interval: ''
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expression: '${A} > 0.85'
              hide: false
              type: math
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: 'âš ï¸ Memory usage above 85%'
        labels:
          severity: warning

      # ---------- HTTP Latency ----------
      - uid: latency_high
        title: High HTTP Request Latency
        condition: B
        data:
          - refId: A
            datasourceUid: ${PROMETHEUS_UID}
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))
              legendFormat: p95_latency
              interval: ''
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expression: '${A} > 2'
              hide: false
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: 'ðŸš¨ P95 HTTP request latency > 2s for 5 minutes'
        labels:
          severity: critical
